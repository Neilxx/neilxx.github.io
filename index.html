<!DOCTYPE html>
<html>
  <head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-132228705-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-132228705-1');
    </script>

    <meta name="description" content="資料來源： 中華郵政郵筒位置查詢網站【每日即時更新】。台灣各縣市郵筒：台北市、新北市、桃園市、臺中市、臺南市、高雄市、新竹縣、苗栗縣、彰化縣、南投縣、雲林縣、嘉義縣、屏東縣、宜蘭縣、花蓮縣、臺東縣、澎湖縣、金門縣、連江縣、基隆市、新竹市、嘉義市">
    <meta name="keywords" content="台灣郵筒位置地圖 | 在 Google Map 上搜尋離你最近的普通郵筒、限時郵筒 【每日即時更新】">
    <meta name="google-site-verification" content="v9MKqidJncD5bdENzNI0yEDZkwCh3VJr5BW0cTRcCgQ" />
    <meta name="msvalidate.01" content="A81048F864056777A8E0E640649B3ECC" />
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <meta property="og:image" content="http://neilxx.github.io/image/bigPostbox.png"/>
    <title>台灣郵筒位置地圖 | 在 Google Map 上搜尋離你最近的普通郵筒、限時郵筒！</title>

    <script type="text/javascript" src="js/post_boxes.js"></script>
    <link rel="stylesheet" href="css/main.css">
    <link rel="icon" type="image/png" sizes="16x16" href="image/favicon-32x32.png">
  </head>
  <body>
    <div class="row">
      <div class="col-md-6 col-7">
        <h1 id="web-title">台灣郵筒位置地圖</h1>
      </div>
    </div>
    <input id="pac-input" class="controls" type="text" placeholder="搜尋地點">
    <div id="map"></div>
    <script>
      function initAutocomplete() {
        const taiwanLatLng = { lat: 23.5, lng: 121 };
        const map = new google.maps.Map(document.getElementById('map'), {
          center: taiwanLatLng,
          zoom: 7,
          mapTypeId: 'roadmap',
          mapTypeControl: false,
          fullscreenControl: false,
        });

        const image = {
          url: 'image/postbox.svg',
          scaledSize: new google.maps.Size(50, 50),
          origin: new google.maps.Point(0, 0),
          anchor: new google.maps.Point(0, 32),
        };

        function bindInfoWindow(marker, map, infowindow, html) {
          marker.addListener('click', function() {
            infowindow.open(map, this);
            infowindow.setContent(html);
          });
        }

        const postBoxMarkers = [];
        postBoxes.forEach(postBox => {
          const marker = new google.maps.Marker({
            position: new google.maps.LatLng(postBox.lat, postBox.lng),
            map,
            icon: image,
            title: postBox.postBoxType.join(', '),
          });
          postBoxMarkers.push(marker);
          const infowindow = new google.maps.InfoWindow();
          const contentString = `<h4>${postBox.postBoxType}</h4><p>${postBox.fullAddress}</p><p>${postBox.note}</p>`;
          bindInfoWindow(marker, map, infowindow, contentString);
        });

        const markerCluster = new MarkerClusterer(map, postBoxMarkers,
            {imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'});

        const input = document.getElementById('pac-input');
        const searchBox = new google.maps.places.SearchBox(input);
        map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);

        map.addListener('bounds_changed', function() {
          searchBox.setBounds(map.getBounds());
        });

        // 在搜尋框搜尋後...
        let existMarkers = [];
        searchBox.addListener('places_changed', function() {
          const places = searchBox.getPlaces();
          if (places.length == 0) return;

          // 移除上次搜尋 marker
          existMarkers.forEach(marker => marker.setMap(null));
          existMarkers = [];

          // Question: 什麼情境下會有多個 place?
          const bounds = new google.maps.LatLngBounds();
          places.forEach(function(place) {
            if (!place.geometry) return;

            const icon = {
              // url: place.icon, // use default icon instead
              size: new google.maps.Size(71, 71),
              origin: new google.maps.Point(0, 0),
              anchor: new google.maps.Point(17, 34),
              scaledSize: new google.maps.Size(25, 25)
            };

            existMarkers.push(new google.maps.Marker({
              map: map,
              icon: icon,
              title: place.name,
              position: place.geometry.location
            }));

            if (place.geometry.viewport) {
              bounds.union(place.geometry.viewport);
            } else {
              bounds.extend(place.geometry.location);
            }
          });
          map.fitBounds(bounds);
        });

        // 瀏覽器自動定位
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                const pos = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                var marker = new google.maps.Marker({
                    position: pos,
                    map,
                });
                map.setZoom(17);
                map.setCenter(pos);
            });
        }
      }

    </script>
    <script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js">
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyANrwP97rB6-tun03pB8yY3NPd3di2BRTI&libraries=places&callback=initAutocomplete"
         async defer></script>
    <!-- <script src="jquery-3.3.1.min.js"></script> -->
  </body>
</html>
